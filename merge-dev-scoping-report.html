<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merge.dev Integration Scoping Report - FULFILL/Worksuite</title>
    <style>
        :root {
            --color-primary: #1976d2;
            --color-primary-dark: #1565c0;
            --color-secondary: #dc004e;
            --color-success: #4caf50;
            --color-warning: #ff9800;
            --color-error: #f44336;
            --color-bg: #ffffff;
            --color-bg-alt: #f5f7fa;
            --color-bg-code: #1e1e1e;
            --color-text: #212121;
            --color-text-secondary: #757575;
            --color-border: #e0e0e0;
            --color-code-text: #d4d4d4;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: var(--color-text);
            background: var(--color-bg);
        }

        .container {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        nav.toc {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            background: var(--color-bg-alt);
            border-right: 1px solid var(--color-border);
            padding: 2rem 1rem;
        }

        nav.toc h2 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--color-text-secondary);
            margin-bottom: 1rem;
            padding-left: 1rem;
        }

        nav.toc ul {
            list-style: none;
        }

        nav.toc li {
            margin-bottom: 0.25rem;
        }

        nav.toc a {
            display: block;
            padding: 0.5rem 1rem;
            color: var(--color-text);
            text-decoration: none;
            border-radius: var(--radius);
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        nav.toc a:hover {
            background: var(--color-border);
        }

        nav.toc a.active {
            background: var(--color-primary);
            color: white;
        }

        /* Main Content */
        main {
            padding: 2rem 3rem;
            max-width: 1000px;
        }

        header.page-header {
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--color-primary);
        }

        header.page-header h1 {
            font-size: 2.5rem;
            color: var(--color-primary);
            margin-bottom: 0.5rem;
        }

        header.page-header .subtitle {
            font-size: 1.2rem;
            color: var(--color-text-secondary);
        }

        header.page-header .meta {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }

        section {
            margin-bottom: 4rem;
        }

        h2 {
            font-size: 1.75rem;
            color: var(--color-primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border);
        }

        h3 {
            font-size: 1.25rem;
            color: var(--color-text);
            margin: 2rem 0 1rem;
        }

        h4 {
            font-size: 1rem;
            color: var(--color-text-secondary);
            margin: 1.5rem 0 0.75rem;
        }

        p {
            margin-bottom: 1rem;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.9rem;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border: 1px solid var(--color-border);
        }

        th {
            background: var(--color-bg-alt);
            font-weight: 600;
            color: var(--color-text);
        }

        tr:hover {
            background: var(--color-bg-alt);
        }

        /* Code Blocks */
        pre {
            background: var(--color-bg-code);
            color: var(--color-code-text);
            padding: 1.5rem;
            border-radius: var(--radius);
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        code {
            font-family: 'Fira Code', 'Consolas', monospace;
            background: var(--color-bg-alt);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.85em;
        }

        pre code {
            background: none;
            padding: 0;
        }

        /* Syntax Highlighting */
        .keyword { color: #569cd6; }
        .string { color: #ce9178; }
        .comment { color: #6a9955; }
        .function { color: #dcdcaa; }
        .type { color: #4ec9b0; }
        .number { color: #b5cea8; }

        /* Cards */
        .card {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: var(--shadow-sm);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        /* Status Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success { background: #e8f5e9; color: #2e7d32; }
        .badge-warning { background: #fff3e0; color: #ef6c00; }
        .badge-error { background: #ffebee; color: #c62828; }
        .badge-info { background: #e3f2fd; color: #1565c0; }

        /* Collapsible Sections */
        details {
            margin: 1rem 0;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
        }

        summary {
            padding: 1rem 1.5rem;
            background: var(--color-bg-alt);
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        summary:hover {
            background: var(--color-border);
        }

        details[open] summary {
            border-bottom: 1px solid var(--color-border);
        }

        details > div {
            padding: 1.5rem;
        }

        /* Architecture Diagram */
        .diagram {
            background: var(--color-bg-alt);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: 2rem;
            margin: 1.5rem 0;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
            line-height: 1.3;
        }

        /* Highlights */
        .highlight {
            background: linear-gradient(120deg, #ffeaa7 0%, #ffeaa7 100%);
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
        }

        /* Lists */
        ul, ol {
            margin: 1rem 0 1rem 2rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        /* Cost Table */
        .cost-table {
            background: var(--color-bg-alt);
        }

        .cost-table th {
            background: var(--color-primary);
            color: white;
        }

        .cost-highlight {
            background: #e8f5e9;
            font-weight: 600;
        }

        /* Print Styles */
        @media print {
            nav.toc { display: none; }
            .container { display: block; }
            main { max-width: none; padding: 1rem; }
            pre { white-space: pre-wrap; font-size: 0.75rem; }
            .page-break { page-break-before: always; }
            details { border: none; }
            details[open] summary { display: none; }
            details > div { padding: 0; }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
            nav.toc { display: none; }
            main { padding: 1rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="toc">
            <h2>Contents</h2>
            <ul>
                <li><a href="#executive-summary">Executive Summary</a></li>
                <li><a href="#architecture">Technical Architecture</a></li>
                <li><a href="#data-mapping">Data Mapping</a></li>
                <li><a href="#code-examples">Code Examples</a></li>
                <li><a href="#implementation">Implementation Phases</a></li>
                <li><a href="#testing">Testing Strategy</a></li>
                <li><a href="#costs">Cost Analysis</a></li>
            </ul>
        </nav>

        <main>
            <header class="page-header">
                <h1>Merge.dev Integration Scoping Report</h1>
                <p class="subtitle">FULFILL/Worksuite Accounting Integration</p>
                <p class="meta">
                    <strong>Version:</strong> 1.0 &nbsp;|&nbsp;
                    <strong>Date:</strong> December 9, 2025 &nbsp;|&nbsp;
                    <strong>Author:</strong> Silver Fern Development Team
                </p>
            </header>

            <!-- EXECUTIVE SUMMARY -->
            <section id="executive-summary">
                <h2>1. Executive Summary</h2>

                <div class="card">
                    <h3>The Problem</h3>
                    <p>FULFILL is an order management system that lacks built-in accounting functionality. Customers need to manually transfer order data to their accounting software (QuickBooks, NetSuite, Xero, etc.), creating:</p>
                    <ul>
                        <li>Manual data entry errors and duplication</li>
                        <li>Delayed financial reporting</li>
                        <li>Disconnected order-to-cash workflows</li>
                        <li>Customer requests for native accounting integration</li>
                    </ul>
                </div>

                <div class="card">
                    <h3>The Solution: Merge.dev</h3>
                    <p>Merge.dev is a <strong>unified API platform</strong> that enables FULFILL to integrate with 8+ accounting platforms through a single integration:</p>
                    <table>
                        <tr>
                            <th>Platform</th>
                            <th>Status</th>
                            <th>Read</th>
                            <th>Write</th>
                        </tr>
                        <tr><td>QuickBooks Online</td><td><span class="badge badge-success">Supported</span></td><td>✅</td><td>✅</td></tr>
                        <tr><td>QuickBooks Desktop</td><td><span class="badge badge-success">Supported</span></td><td>✅</td><td>✅</td></tr>
                        <tr><td>NetSuite</td><td><span class="badge badge-success">Supported</span></td><td>✅</td><td>✅</td></tr>
                        <tr><td>Sage Intacct</td><td><span class="badge badge-success">Supported</span></td><td>✅</td><td>✅</td></tr>
                        <tr><td>Sage Business Cloud</td><td><span class="badge badge-success">Supported</span></td><td>✅</td><td>✅</td></tr>
                        <tr><td>Microsoft Dynamics 365</td><td><span class="badge badge-success">Supported</span></td><td>✅</td><td>✅</td></tr>
                        <tr><td>Xero</td><td><span class="badge badge-success">Supported</span></td><td>✅</td><td>✅</td></tr>
                        <tr><td>Acumatica</td><td><span class="badge badge-warning">Not Yet</span></td><td>-</td><td>-</td></tr>
                    </table>
                </div>

                <div class="card">
                    <h3>Key Benefits</h3>
                    <ul>
                        <li><strong>Single Integration:</strong> Write code once, connect to 8+ platforms</li>
                        <li><strong>Fast Time-to-Market:</strong> 2-3 weeks MVP vs. 6-12 months building in-house</li>
                        <li><strong>Customer-Facing Auth:</strong> Drop-in Merge Link UI for customer onboarding</li>
                        <li><strong>Zero Maintenance:</strong> Merge handles API changes, not your dev team</li>
                        <li><strong>Normalized Data:</strong> Common Models simplify data transformation</li>
                    </ul>
                </div>

                <div class="card">
                    <h3>Recommendation</h3>
                    <p><span class="highlight"><strong>Proceed with Merge.dev integration.</strong></span> The ROI is compelling:</p>
                    <table class="cost-table">
                        <tr>
                            <th>Approach</th>
                            <th>Initial Cost</th>
                            <th>Time to Market</th>
                            <th>Ongoing Cost</th>
                        </tr>
                        <tr>
                            <td>Build In-House (8 platforms)</td>
                            <td>$150k - $300k</td>
                            <td>6-12 months</td>
                            <td>$50k+/year maintenance</td>
                        </tr>
                        <tr class="cost-highlight">
                            <td>Use Merge.dev</td>
                            <td>~$15k (dev time)</td>
                            <td>2-3 weeks</td>
                            <td>$7.8k - $78k/year*</td>
                        </tr>
                    </table>
                    <p style="font-size: 0.85rem; color: var(--color-text-secondary);">*Based on 10-100 connected customers at $65/customer/month</p>
                </div>

                <div class="card">
                    <h3>Key Decisions for Stakeholders</h3>
                    <ol>
                        <li><strong>Sync Timing:</strong> Create invoices when order status = "Shipped" (recommended) or "Closed"?</li>
                        <li><strong>Customer Locations:</strong> One contact per customer, or one per location?</li>
                        <li><strong>Pricing Model:</strong> Include in base FULFILL pricing or as paid add-on?</li>
                        <li><strong>Manual vs. Auto:</strong> Automatic sync or manual approval before sync?</li>
                    </ol>
                </div>
            </section>

            <!-- TECHNICAL ARCHITECTURE -->
            <section id="architecture" class="page-break">
                <h2>2. Technical Architecture</h2>

                <h3>System Overview</h3>
                <div class="diagram">
┌─────────────────────────────────────────────────────────────────────────────┐
│                           FULFILL Application                                │
│                                                                              │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────┐  │
│  │     React       │───▶│     Redux       │───▶│    MergeService         │  │
│  │   Components    │    │     Store       │    │    (Singleton)          │  │
│  │                 │    │                 │    │                         │  │
│  │ • MergeLinkBtn  │    │ • mergeSlice    │    │ • getLinkToken()        │  │
│  │ • SyncStatus    │    │ • connection    │    │ • createInvoice()       │  │
│  │ • ConnectionUI  │    │ • syncHistory   │    │ • createContact()       │  │
│  └─────────────────┘    └─────────────────┘    └───────────┬─────────────┘  │
│                                                             │                │
└─────────────────────────────────────────────────────────────┼────────────────┘
                                                              │
                                                              │ REST API
                                                              │ X-Account-Token
                                                              ▼
                              ┌────────────────────────────────────────────────┐
                              │              Merge.dev API                      │
                              │       https://api.merge.dev/api/accounting/v1   │
                              │                                                 │
                              │  Common Models:                                 │
                              │  • Contact (Customers/Vendors)                  │
                              │  • Item (Products/Services)                     │
                              │  • Invoice (AR/AP)                              │
                              │  • Payment                                      │
                              └───────────────────────┬────────────────────────┘
                                                      │
                    ┌─────────────────────────────────┼─────────────────────────┐
                    │                                 │                         │
              ┌─────▼─────┐  ┌─────▼─────┐  ┌───────▼───────┐  ┌─────▼─────┐   │
              │QuickBooks │  │  NetSuite │  │     Xero      │  │   Sage    │   │
              │  Online   │  │           │  │               │  │  Intacct  │   │
              └───────────┘  └───────────┘  └───────────────┘  └───────────┘   │
                                                                                │
              ┌───────────┐  ┌───────────┐  ┌───────────────┐                   │
              │QuickBooks │  │ Dynamics  │  │  Sage Cloud   │                   │
              │  Desktop  │  │    365    │  │               │                   │
              └───────────┘  └───────────┘  └───────────────┘                   │
                                                                                │
                              (8+ Accounting Platforms)                         │
                                                                                │
                              Each customer connects their                      │
                              own accounting software via                       │
                              Merge Link OAuth flow                             │
                                                                                │
</div>

                <h3>Authentication Flow (Merge Link)</h3>
                <div class="diagram">
┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   FULFILL    │     │   FULFILL    │     │  Merge.dev   │     │  QuickBooks  │
│   Frontend   │     │   Backend    │     │     API      │     │    OAuth     │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │                    │
       │  1. Click "Connect │                    │                    │
       │     Accounting"    │                    │                    │
       │───────────────────▶│                    │                    │
       │                    │                    │                    │
       │                    │ 2. POST /link-token│                    │
       │                    │───────────────────▶│                    │
       │                    │                    │                    │
       │                    │ 3. {link_token}    │                    │
       │                    │◀───────────────────│                    │
       │                    │                    │                    │
       │ 4. link_token      │                    │                    │
       │◀───────────────────│                    │                    │
       │                    │                    │                    │
       │ 5. Open Merge Link Modal               │                    │
       │─────────────────────────────────────────────────────────────▶│
       │                    │                    │                    │
       │                    │        6. User authenticates with QB    │
       │                    │                    │◀───────────────────│
       │                    │                    │                    │
       │ 7. public_token    │                    │                    │
       │◀────────────────────────────────────────│                    │
       │                    │                    │                    │
       │ 8. Send public_token                   │                    │
       │───────────────────▶│                    │                    │
       │                    │                    │                    │
       │                    │ 9. POST /account-token                 │
       │                    │───────────────────▶│                    │
       │                    │                    │                    │
       │                    │ 10. {account_token}│                    │
       │                    │◀───────────────────│                    │
       │                    │                    │                    │
       │                    │ 11. Store token    │                    │
       │                    │     (encrypted)    │                    │
       │                    │                    │                    │
       │ 12. Success!       │                    │                    │
       │◀───────────────────│                    │                    │
       │                    │                    │                    │
</div>

                <h3>Data Flow: Order to Invoice</h3>
                <div class="diagram">
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Order Lifecycle in FULFILL                          │
│                                                                             │
│   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐     │
│   │  Open   │──▶│Submitted│──▶│  Acked  │──▶│ Picked  │──▶│ SHIPPED │     │
│   └─────────┘   └─────────┘   └─────────┘   └─────────┘   └────┬────┘     │
│                                                                  │          │
│                                                                  │ Trigger  │
│                                                                  ▼          │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    Accounting Sync Service                           │  │
│   │                                                                      │  │
│   │  1. Check if customer has Merge connection                          │  │
│   │  2. Check/create Contact in accounting system                        │  │
│   │  3. Map order data → Merge Invoice format                           │  │
│   │  4. POST /invoices to Merge API                                     │  │
│   │  5. Store merge_invoice_id on order                                 │  │
│   │  6. Update order.accounting_sync_status = "synced"                  │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Customer's QuickBooks                               │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Invoice #12345                                                      │  │
│   │  ─────────────────────────────────────────────────                  │  │
│   │  Customer: Acme Growers Inc                                         │  │
│   │  PO Number: PO-67890                                                │  │
│   │  Date: 2025-12-09                                                   │  │
│   │  Due: 2025-01-08 (Net 30)                                           │  │
│   │                                                                      │  │
│   │  Line Items:                                                         │  │
│   │  ───────────────────────────────────────────────                    │  │
│   │  Product A (SKU-001)    x 100    @ $5.99    $599.00                 │  │
│   │  Product B (SKU-002)    x  50    @ $3.49    $174.50                 │  │
│   │                                             ─────────               │  │
│   │                                    Total:   $773.50                 │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</div>
            </section>

            <!-- DATA MAPPING -->
            <section id="data-mapping" class="page-break">
                <h2>3. Data Mapping Specifications</h2>

                <h3>3.1 Customer → Contact Mapping</h3>
                <table>
                    <tr>
                        <th>FULFILL Field</th>
                        <th>Type</th>
                        <th>Merge Contact Field</th>
                        <th>Notes</th>
                    </tr>
                    <tr><td><code>customerId</code></td><td>string</td><td><code>remote_id</code></td><td>Store FULFILL ID for lookup</td></tr>
                    <tr><td><code>name</code></td><td>string</td><td><code>company_name</code></td><td>Company name</td></tr>
                    <tr><td><code>status</code></td><td>string</td><td><code>status</code></td><td>"Active" → "ACTIVE"</td></tr>
                    <tr><td><code>contacts[0].firstName</code></td><td>string</td><td><code>first_name</code></td><td>Primary contact</td></tr>
                    <tr><td><code>contacts[0].lastName</code></td><td>string</td><td><code>last_name</code></td><td>Primary contact</td></tr>
                    <tr><td><code>contacts[0].emailAddress</code></td><td>string</td><td><code>email_addresses[0].email_address</code></td><td>Primary email</td></tr>
                    <tr><td><code>contacts[0].phoneNumber</code></td><td>string</td><td><code>phone_numbers[0].phone_number</code></td><td>Primary phone</td></tr>
                    <tr><td><code>addresses[0].addressLine1</code></td><td>string</td><td><code>addresses[0].street_1</code></td><td>Billing address</td></tr>
                    <tr><td><code>addresses[0].city</code></td><td>string</td><td><code>addresses[0].city</code></td><td>City</td></tr>
                    <tr><td><code>addresses[0].stateProvince</code></td><td>string</td><td><code>addresses[0].state</code></td><td>State/Province</td></tr>
                    <tr><td><code>addresses[0].zipcode</code></td><td>string</td><td><code>addresses[0].postal_code</code></td><td>ZIP/Postal code</td></tr>
                </table>

                <h3>3.2 Item/Product → Item Mapping</h3>
                <table>
                    <tr>
                        <th>FULFILL Field</th>
                        <th>Type</th>
                        <th>Merge Item Field</th>
                        <th>Notes</th>
                    </tr>
                    <tr><td><code>itemId</code></td><td>string</td><td><code>remote_id</code></td><td>FULFILL item ID</td></tr>
                    <tr><td><code>itemName</code></td><td>string</td><td><code>name</code></td><td>Product name</td></tr>
                    <tr><td><code>description</code></td><td>string</td><td><code>description</code></td><td>Product description</td></tr>
                    <tr><td><code>retailPrice</code></td><td>number</td><td><code>unit_price</code></td><td>Default selling price</td></tr>
                    <tr><td><code>sku</code></td><td>string</td><td><code>remote_id</code> (alt)</td><td>SKU in custom field</td></tr>
                    <tr><td><code>status</code></td><td>string</td><td><code>status</code></td><td>"Active" → "ACTIVE"</td></tr>
                </table>

                <h3>3.3 Order → Invoice Mapping</h3>
                <table>
                    <tr>
                        <th>FULFILL Field</th>
                        <th>Type</th>
                        <th>Merge Invoice Field</th>
                        <th>Notes</th>
                    </tr>
                    <tr><td><code>orderId</code></td><td>string</td><td><code>remote_id</code></td><td>FULFILL order ID</td></tr>
                    <tr><td><code>orderNumber</code></td><td>string</td><td><code>number</code></td><td>Invoice number</td></tr>
                    <tr><td><code>customerId</code></td><td>string</td><td><code>contact</code></td><td>Merge Contact ID (lookup)</td></tr>
                    <tr><td><code>type</code></td><td>OrderType</td><td><code>type</code></td><td>"PO" → "ACCOUNTS_RECEIVABLE"</td></tr>
                    <tr><td><code>status</code></td><td>string</td><td><code>status</code></td><td>"Shipped" → "SUBMITTED"</td></tr>
                    <tr><td><code>poNumber</code></td><td>string</td><td><code>purchase_order</code></td><td>Customer PO reference</td></tr>
                    <tr><td><code>expectedDeliveryDate</code></td><td>TDateISO</td><td><code>due_date</code></td><td>Payment due date</td></tr>
                    <tr><td>(calculated)</td><td>TDateISO</td><td><code>issue_date</code></td><td>When shipped</td></tr>
                    <tr><td><code>lineItems[]</code></td><td>LineItem[]</td><td><code>line_items[]</code></td><td>See below</td></tr>
                </table>

                <h4>Order Line Item Mapping</h4>
                <table>
                    <tr>
                        <th>FULFILL Field</th>
                        <th>Merge Invoice Line Item Field</th>
                    </tr>
                    <tr><td><code>itemId</code></td><td><code>item</code> (Merge Item ID)</td></tr>
                    <tr><td><code>quantity</code></td><td><code>quantity</code></td></tr>
                    <tr><td><code>overridePrice</code> or calculated</td><td><code>unit_price</code></td></tr>
                    <tr><td><code>quantity * unitPrice</code></td><td><code>total_line_amount</code></td></tr>
                    <tr><td>Item description</td><td><code>description</code></td></tr>
                </table>

                <h3>3.4 Status Mapping</h3>
                <table>
                    <tr>
                        <th>FULFILL Order Status</th>
                        <th>Merge Invoice Status</th>
                        <th>Sync Action</th>
                    </tr>
                    <tr><td>Open, Submitted, Acknowledged, Picked</td><td>-</td><td>Do not sync yet</td></tr>
                    <tr><td><strong>Shipped</strong></td><td><code>SUBMITTED</code></td><td><span class="badge badge-success">Create Invoice</span></td></tr>
                    <tr><td>Synchronized</td><td><code>SUBMITTED</code></td><td>Already synced</td></tr>
                    <tr><td>Closed</td><td><code>PAID</code></td><td>Update to paid (Phase 2)</td></tr>
                    <tr><td>Cancelled</td><td><code>VOID</code></td><td>Void invoice</td></tr>
                </table>
            </section>

            <!-- CODE EXAMPLES -->
            <section id="code-examples" class="page-break">
                <h2>4. Code Examples (Worksuite Patterns)</h2>
                <p>All code examples follow existing worksuite-pwa patterns and conventions, including singleton services, RTK Query, Redux Toolkit, and TypeScript strict mode.</p>

                <details open>
                    <summary>4.1 MergeService - Singleton Service Class</summary>
                    <div>
                        <p>Based on <code>src/services/intercom.ts</code> pattern:</p>
<pre><code><span class="comment">// src/services/merge.ts</span>

<span class="keyword">interface</span> <span class="type">MergeUser</span> {
  endUserOrganizationName: <span class="type">string</span>;
  endUserOriginId: <span class="type">string</span>;
  categories: <span class="type">string</span>[];
}

<span class="keyword">interface</span> <span class="type">MergeLinkToken</span> {
  linkToken: <span class="type">string</span>;
}

<span class="keyword">interface</span> <span class="type">MergeAccountToken</span> {
  accountToken: <span class="type">string</span>;
  integration: {
    name: <span class="type">string</span>;
    categories: <span class="type">string</span>[];
  };
}

<span class="keyword">interface</span> <span class="type">MergeContact</span> {
  id: <span class="type">string</span>;
  remoteId: <span class="type">string</span> | <span class="keyword">null</span>;
  companyName: <span class="type">string</span> | <span class="keyword">null</span>;
  status: <span class="string">"ACTIVE"</span> | <span class="string">"INACTIVE"</span> | <span class="keyword">null</span>;
  firstName: <span class="type">string</span> | <span class="keyword">null</span>;
  lastName: <span class="type">string</span> | <span class="keyword">null</span>;
  emailAddresses: { emailAddress: <span class="type">string</span>; emailAddressType: <span class="type">string</span> }[];
  phoneNumbers: { phoneNumber: <span class="type">string</span>; phoneNumberType: <span class="type">string</span> }[];
  addresses: <span class="type">MergeAddress</span>[];
}

<span class="keyword">interface</span> <span class="type">MergeInvoice</span> {
  id: <span class="type">string</span>;
  remoteId: <span class="type">string</span> | <span class="keyword">null</span>;
  number: <span class="type">string</span> | <span class="keyword">null</span>;
  type: <span class="string">"ACCOUNTS_RECEIVABLE"</span> | <span class="string">"ACCOUNTS_PAYABLE"</span>;
  status: <span class="string">"DRAFT"</span> | <span class="string">"SUBMITTED"</span> | <span class="string">"PAID"</span> | <span class="string">"VOID"</span> | <span class="keyword">null</span>;
  issueDate: <span class="type">string</span> | <span class="keyword">null</span>;
  dueDate: <span class="type">string</span> | <span class="keyword">null</span>;
  contact: <span class="type">string</span> | <span class="keyword">null</span>;
  purchaseOrder: <span class="type">string</span> | <span class="keyword">null</span>;
  totalAmount: <span class="type">number</span> | <span class="keyword">null</span>;
  lineItems: <span class="type">MergeInvoiceLineItem</span>[];
}

<span class="keyword">interface</span> <span class="type">MergeInvoiceLineItem</span> {
  item: <span class="type">string</span> | <span class="keyword">null</span>;
  description: <span class="type">string</span> | <span class="keyword">null</span>;
  quantity: <span class="type">number</span> | <span class="keyword">null</span>;
  unitPrice: <span class="type">number</span> | <span class="keyword">null</span>;
  totalLineAmount: <span class="type">number</span> | <span class="keyword">null</span>;
}

<span class="keyword">class</span> <span class="type">MergeService</span> {
  <span class="keyword">private static</span> instance: <span class="type">MergeService</span>;
  <span class="keyword">private</span> initialized = <span class="keyword">false</span>;
  <span class="keyword">private</span> accountToken: <span class="type">string</span> | <span class="keyword">null</span> = <span class="keyword">null</span>;
  <span class="keyword">private readonly</span> baseUrl = <span class="string">"https://api.merge.dev/api/accounting/v1"</span>;

  <span class="keyword">private</span> <span class="function">constructor</span>() {}

  <span class="keyword">static</span> <span class="function">getInstance</span>(): <span class="type">MergeService</span> {
    <span class="keyword">if</span> (!<span class="type">MergeService</span>.instance) {
      <span class="type">MergeService</span>.instance = <span class="keyword">new</span> <span class="type">MergeService</span>();
    }
    <span class="keyword">return</span> <span class="type">MergeService</span>.instance;
  }

  <span class="comment">/**
   * Initialize the Merge service with an account token
   * Should be called after user connects their accounting software
   */</span>
  <span class="function">initialize</span>(accountToken: <span class="type">string</span>): <span class="keyword">void</span> {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> window === <span class="string">"undefined"</span>) {
      console.<span class="function">warn</span>(<span class="string">"MergeService: Cannot initialize on server-side"</span>);
      <span class="keyword">return</span>;
    }

    <span class="keyword">if</span> (<span class="keyword">this</span>.initialized && <span class="keyword">this</span>.accountToken === accountToken) {
      console.<span class="function">warn</span>(<span class="string">"MergeService: Already initialized with this token"</span>);
      <span class="keyword">return</span>;
    }

    <span class="keyword">try</span> {
      <span class="keyword">this</span>.accountToken = accountToken;
      <span class="keyword">this</span>.initialized = <span class="keyword">true</span>;
      console.<span class="function">log</span>(<span class="string">"MergeService: Initialized successfully"</span>);
    } <span class="keyword">catch</span> (error) {
      console.<span class="function">error</span>(<span class="string">"MergeService: Failed to initialize:"</span>, error);
    }
  }

  <span class="comment">/**
   * Get a link token for Merge Link modal
   * NOTE: In production, call this from backend to protect API key
   */</span>
  <span class="keyword">async</span> <span class="function">getLinkToken</span>(user: <span class="type">MergeUser</span>): <span class="type">Promise</span>&lt;<span class="type">MergeLinkToken</span> | <span class="keyword">null</span>&gt; {
    <span class="keyword">try</span> {
      <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="function">fetch</span>(<span class="string">"https://api.merge.dev/api/v1/link-token"</span>, {
        body: <span class="type">JSON</span>.<span class="function">stringify</span>({
          categories: user.categories,
          end_user_organization_name: user.endUserOrganizationName,
          end_user_origin_id: user.endUserOriginId,
        }),
        headers: {
          Authorization: <span class="string">`Bearer ${Config.mergeApiKey}`</span>,
          <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,
        },
        method: <span class="string">"POST"</span>,
      });

      <span class="keyword">if</span> (!response.ok) {
        <span class="keyword">throw new</span> <span class="type">Error</span>(<span class="string">`Failed to get link token: ${response.statusText}`</span>);
      }

      <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="function">json</span>();
      <span class="keyword">return</span> { linkToken: data.link_token };
    } <span class="keyword">catch</span> (error) {
      console.<span class="function">error</span>(<span class="string">"MergeService: Failed to get link token:"</span>, error);
      <span class="keyword">return null</span>;
    }
  }

  <span class="comment">/**
   * Exchange public token for account token
   * NOTE: In production, call this from backend
   */</span>
  <span class="keyword">async</span> <span class="function">exchangePublicToken</span>(publicToken: <span class="type">string</span>): <span class="type">Promise</span>&lt;<span class="type">MergeAccountToken</span> | <span class="keyword">null</span>&gt; {
    <span class="keyword">try</span> {
      <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="function">fetch</span>(<span class="string">"https://api.merge.dev/api/v1/account-token"</span>, {
        body: <span class="type">JSON</span>.<span class="function">stringify</span>({ public_token: publicToken }),
        headers: {
          Authorization: <span class="string">`Bearer ${Config.mergeApiKey}`</span>,
          <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,
        },
        method: <span class="string">"POST"</span>,
      });

      <span class="keyword">if</span> (!response.ok) {
        <span class="keyword">throw new</span> <span class="type">Error</span>(<span class="string">`Failed to exchange token: ${response.statusText}`</span>);
      }

      <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="function">json</span>();
      <span class="keyword">return</span> {
        accountToken: data.account_token,
        integration: {
          categories: data.integration.categories,
          name: data.integration.name,
        },
      };
    } <span class="keyword">catch</span> (error) {
      console.<span class="function">error</span>(<span class="string">"MergeService: Failed to exchange token:"</span>, error);
      <span class="keyword">return null</span>;
    }
  }

  <span class="comment">/**
   * Create an invoice in the connected accounting system
   */</span>
  <span class="keyword">async</span> <span class="function">createInvoice</span>(invoice: <span class="type">Omit</span>&lt;<span class="type">MergeInvoice</span>, <span class="string">"id"</span>&gt;): <span class="type">Promise</span>&lt;<span class="type">MergeInvoice</span> | <span class="keyword">null</span>&gt; {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.initialized || !<span class="keyword">this</span>.accountToken) {
      console.<span class="function">warn</span>(<span class="string">"MergeService: Not initialized, cannot create invoice"</span>);
      <span class="keyword">return null</span>;
    }

    <span class="keyword">try</span> {
      <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="function">fetch</span>(<span class="string">`${this.baseUrl}/invoices`</span>, {
        body: <span class="type">JSON</span>.<span class="function">stringify</span>({
          model: {
            contact: invoice.contact,
            due_date: invoice.dueDate,
            issue_date: invoice.issueDate,
            line_items: invoice.lineItems.<span class="function">map</span>((li) =&gt; ({
              description: li.description,
              item: li.item,
              quantity: li.quantity,
              total_line_amount: li.totalLineAmount,
              unit_price: li.unitPrice,
            })),
            number: invoice.number,
            purchase_order: invoice.purchaseOrder,
            remote_id: invoice.remoteId,
            status: invoice.status,
            total_amount: invoice.totalAmount,
            type: invoice.type,
          },
        }),
        headers: {
          Authorization: <span class="string">`Bearer ${Config.mergeApiKey}`</span>,
          <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,
          <span class="string">"X-Account-Token"</span>: <span class="keyword">this</span>.accountToken,
        },
        method: <span class="string">"POST"</span>,
      });

      <span class="keyword">if</span> (!response.ok) {
        <span class="keyword">throw new</span> <span class="type">Error</span>(<span class="string">`Failed to create invoice: ${response.statusText}`</span>);
      }

      <span class="keyword">return await</span> response.<span class="function">json</span>();
    } <span class="keyword">catch</span> (error) {
      console.<span class="function">error</span>(<span class="string">"MergeService: Failed to create invoice:"</span>, error);
      <span class="keyword">return null</span>;
    }
  }

  <span class="comment">/**
   * Create a contact in the connected accounting system
   */</span>
  <span class="keyword">async</span> <span class="function">createContact</span>(contact: <span class="type">Omit</span>&lt;<span class="type">MergeContact</span>, <span class="string">"id"</span>&gt;): <span class="type">Promise</span>&lt;<span class="type">MergeContact</span> | <span class="keyword">null</span>&gt; {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.initialized || !<span class="keyword">this</span>.accountToken) {
      console.<span class="function">warn</span>(<span class="string">"MergeService: Not initialized, cannot create contact"</span>);
      <span class="keyword">return null</span>;
    }

    <span class="keyword">try</span> {
      <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="function">fetch</span>(<span class="string">`${this.baseUrl}/contacts`</span>, {
        body: <span class="type">JSON</span>.<span class="function">stringify</span>({
          model: {
            addresses: contact.addresses,
            company_name: contact.companyName,
            email_addresses: contact.emailAddresses.<span class="function">map</span>((e) =&gt; ({
              email_address: e.emailAddress,
              email_address_type: e.emailAddressType,
            })),
            first_name: contact.firstName,
            last_name: contact.lastName,
            phone_numbers: contact.phoneNumbers.<span class="function">map</span>((p) =&gt; ({
              phone_number: p.phoneNumber,
              phone_number_type: p.phoneNumberType,
            })),
            remote_id: contact.remoteId,
            status: contact.status,
          },
        }),
        headers: {
          Authorization: <span class="string">`Bearer ${Config.mergeApiKey}`</span>,
          <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>,
          <span class="string">"X-Account-Token"</span>: <span class="keyword">this</span>.accountToken,
        },
        method: <span class="string">"POST"</span>,
      });

      <span class="keyword">if</span> (!response.ok) {
        <span class="keyword">throw new</span> <span class="type">Error</span>(<span class="string">`Failed to create contact: ${response.statusText}`</span>);
      }

      <span class="keyword">return await</span> response.<span class="function">json</span>();
    } <span class="keyword">catch</span> (error) {
      console.<span class="function">error</span>(<span class="string">"MergeService: Failed to create contact:"</span>, error);
      <span class="keyword">return null</span>;
    }
  }

  <span class="comment">/**
   * Get contacts from connected accounting system
   */</span>
  <span class="keyword">async</span> <span class="function">getContacts</span>(remoteId?: <span class="type">string</span>): <span class="type">Promise</span>&lt;<span class="type">MergeContact</span>[]&gt; {
    <span class="keyword">if</span> (!<span class="keyword">this</span>.initialized || !<span class="keyword">this</span>.accountToken) {
      console.<span class="function">warn</span>(<span class="string">"MergeService: Not initialized"</span>);
      <span class="keyword">return</span> [];
    }

    <span class="keyword">try</span> {
      <span class="keyword">const</span> url = <span class="keyword">new</span> <span class="type">URL</span>(<span class="string">`${this.baseUrl}/contacts`</span>);
      <span class="keyword">if</span> (remoteId) {
        url.searchParams.<span class="function">append</span>(<span class="string">"remote_id"</span>, remoteId);
      }

      <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="function">fetch</span>(url.<span class="function">toString</span>(), {
        headers: {
          Authorization: <span class="string">`Bearer ${Config.mergeApiKey}`</span>,
          <span class="string">"X-Account-Token"</span>: <span class="keyword">this</span>.accountToken,
        },
        method: <span class="string">"GET"</span>,
      });

      <span class="keyword">if</span> (!response.ok) {
        <span class="keyword">throw new</span> <span class="type">Error</span>(<span class="string">`Failed to get contacts: ${response.statusText}`</span>);
      }

      <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="function">json</span>();
      <span class="keyword">return</span> data.results || [];
    } <span class="keyword">catch</span> (error) {
      console.<span class="function">error</span>(<span class="string">"MergeService: Failed to get contacts:"</span>, error);
      <span class="keyword">return</span> [];
    }
  }

  <span class="comment">/** Check if service is initialized */</span>
  <span class="function">isInitialized</span>(): <span class="type">boolean</span> {
    <span class="keyword">return this</span>.initialized;
  }

  <span class="comment">/** Shutdown and clear connection */</span>
  <span class="function">shutdown</span>(): <span class="keyword">void</span> {
    <span class="keyword">this</span>.accountToken = <span class="keyword">null</span>;
    <span class="keyword">this</span>.initialized = <span class="keyword">false</span>;
    console.<span class="function">log</span>(<span class="string">"MergeService: Shutdown complete"</span>);
  }
}

<span class="keyword">export default</span> <span class="type">MergeService</span>;</code></pre>
                    </div>
                </details>

                <details>
                    <summary>4.2 Redux Slice - mergeSlice.ts</summary>
                    <div>
                        <p>Based on <code>src/store/orderSlice.ts</code> pattern:</p>
<pre><code><span class="comment">// src/store/mergeSlice.ts</span>
<span class="keyword">import</span> { createSlice, <span class="type">PayloadAction</span> } <span class="keyword">from</span> <span class="string">"@reduxjs/toolkit"</span>;
<span class="keyword">import</span> { <span class="type">TDateISO</span> } <span class="keyword">from</span> <span class="string">"~/@types/TDateISO"</span>;

<span class="keyword">export type</span> <span class="type">MergeSyncStatus</span> = <span class="string">"idle"</span> | <span class="string">"pending"</span> | <span class="string">"synced"</span> | <span class="string">"error"</span>;
<span class="keyword">export type</span> <span class="type">MergeConnectionStatus</span> = <span class="string">"disconnected"</span> | <span class="string">"connecting"</span> | <span class="string">"connected"</span> | <span class="string">"error"</span>;

<span class="keyword">export interface</span> <span class="type">MergeConnection</span> {
  accountToken: <span class="type">string</span> | <span class="keyword">null</span>;
  connectedAt: <span class="type">TDateISO</span> | <span class="keyword">null</span>;
  connectionStatus: <span class="type">MergeConnectionStatus</span>;
  integrationName: <span class="type">string</span> | <span class="keyword">null</span>;
  lastSyncAt: <span class="type">TDateISO</span> | <span class="keyword">null</span>;
}

<span class="keyword">export interface</span> <span class="type">MergeSyncRecord</span> {
  errorMessage: <span class="type">string</span> | <span class="keyword">null</span>;
  fulfillEntityId: <span class="type">string</span>;
  fulfillEntityType: <span class="string">"customer"</span> | <span class="string">"item"</span> | <span class="string">"order"</span>;
  mergeEntityId: <span class="type">string</span> | <span class="keyword">null</span>;
  mergeEntityType: <span class="string">"contact"</span> | <span class="string">"item"</span> | <span class="string">"invoice"</span>;
  status: <span class="type">MergeSyncStatus</span>;
  syncedAt: <span class="type">TDateISO</span> | <span class="keyword">null</span>;
}

<span class="keyword">export interface</span> <span class="type">AccountMapping</span> {
  arAccountId: <span class="type">string</span> | <span class="keyword">null</span>;
  cogsAccountId: <span class="type">string</span> | <span class="keyword">null</span>;
  revenueAccountId: <span class="type">string</span> | <span class="keyword">null</span>;
}

<span class="keyword">interface</span> <span class="type">MergeState</span> {
  accountMapping: <span class="type">AccountMapping</span>;
  connection: <span class="type">MergeConnection</span>;
  syncHistory: <span class="type">MergeSyncRecord</span>[];
  syncQueueCount: <span class="type">number</span>;
}

<span class="keyword">const</span> initialState: <span class="type">MergeState</span> = {
  accountMapping: {
    arAccountId: <span class="keyword">null</span>,
    cogsAccountId: <span class="keyword">null</span>,
    revenueAccountId: <span class="keyword">null</span>,
  },
  connection: {
    accountToken: <span class="keyword">null</span>,
    connectedAt: <span class="keyword">null</span>,
    connectionStatus: <span class="string">"disconnected"</span>,
    integrationName: <span class="keyword">null</span>,
    lastSyncAt: <span class="keyword">null</span>,
  },
  syncHistory: [],
  syncQueueCount: <span class="number">0</span>,
};

<span class="keyword">export const</span> mergeSlice = <span class="function">createSlice</span>({
  initialState,
  name: <span class="string">"merge"</span>,
  reducers: {
    <span class="function">addSyncRecord</span>: (state, action: <span class="type">PayloadAction</span>&lt;<span class="type">MergeSyncRecord</span>&gt;) =&gt; {
      state.syncHistory.<span class="function">unshift</span>(action.payload);
      <span class="comment">// Keep only last 100 records</span>
      <span class="keyword">if</span> (state.syncHistory.length &gt; <span class="number">100</span>) {
        state.syncHistory = state.syncHistory.<span class="function">slice</span>(<span class="number">0</span>, <span class="number">100</span>);
      }
    },
    <span class="function">clearConnection</span>: (state) =&gt; {
      state.connection = initialState.connection;
      state.accountMapping = initialState.accountMapping;
    },
    <span class="function">setConnection</span>: (state, action: <span class="type">PayloadAction</span>&lt;<span class="type">Partial</span>&lt;<span class="type">MergeConnection</span>&gt;&gt;) =&gt; {
      state.connection = { ...state.connection, ...action.payload };
    },
    <span class="function">setConnectionStatus</span>: (state, action: <span class="type">PayloadAction</span>&lt;<span class="type">MergeConnectionStatus</span>&gt;) =&gt; {
      state.connection.connectionStatus = action.payload;
    },
    <span class="function">setAccountMapping</span>: (state, action: <span class="type">PayloadAction</span>&lt;<span class="type">Partial</span>&lt;<span class="type">AccountMapping</span>&gt;&gt;) =&gt; {
      state.accountMapping = { ...state.accountMapping, ...action.payload };
    },
    <span class="function">setSyncQueueCount</span>: (state, action: <span class="type">PayloadAction</span>&lt;<span class="type">number</span>&gt;) =&gt; {
      state.syncQueueCount = action.payload;
    },
    <span class="function">updateSyncRecord</span>: (
      state,
      action: <span class="type">PayloadAction</span>&lt;{
        fulfillEntityId: <span class="type">string</span>;
        updates: <span class="type">Partial</span>&lt;<span class="type">MergeSyncRecord</span>&gt;;
      }&gt;
    ) =&gt; {
      <span class="keyword">const</span> record = state.syncHistory.<span class="function">find</span>(
        (r) =&gt; r.fulfillEntityId === action.payload.fulfillEntityId
      );
      <span class="keyword">if</span> (record) {
        <span class="type">Object</span>.<span class="function">assign</span>(record, action.payload.updates);
      }
    },
  },
});

<span class="keyword">export const</span> {
  addSyncRecord,
  clearConnection,
  setAccountMapping,
  setConnection,
  setConnectionStatus,
  setSyncQueueCount,
  updateSyncRecord,
} = mergeSlice.actions;

<span class="keyword">export default</span> mergeSlice.reducer;</code></pre>
                    </div>
                </details>

                <details>
                    <summary>4.3 RTK Query Endpoints - mergeEndpoints.ts</summary>
                    <div>
                        <p>Based on <code>src/services/endpoints/ordersEndpoints.ts</code> pattern:</p>
<pre><code><span class="comment">// src/services/endpoints/mergeEndpoints.ts</span>
<span class="keyword">import</span> {
  <span class="type">GetMergeConnectionQuery</span>,
  <span class="type">GetMergeContactsQuery</span>,
  <span class="type">GetMergeInvoicesQuery</span>,
  <span class="type">InitiateMergeConnectionMutation</span>,
  <span class="type">CreateMergeInvoiceMutation</span>,
  <span class="type">SyncOrderToMergeMutation</span>,
  <span class="type">DisconnectMergeMutation</span>,
} <span class="keyword">from</span> <span class="string">"~/services/graphql"</span>;

<span class="keyword">import type</span> { <span class="type">AddTagTypes</span> } <span class="keyword">from</span> <span class="string">"~/services/endpoints"</span>;

<span class="keyword">export const</span> mergeEndpoints = {
  <span class="comment">// Queries</span>
  GetMergeConnection: {
    providesTags: [<span class="string">"MergeConnection"</span>] <span class="keyword">as</span> <span class="type">AddTagTypes</span>,
    transformResponse: (res: <span class="type">GetMergeConnectionQuery</span>) =&gt; res.mergeConnection,
  },
  GetMergeContacts: {
    providesTags: [<span class="string">"MergeContacts"</span>] <span class="keyword">as</span> <span class="type">AddTagTypes</span>,
    transformResponse: (res: <span class="type">GetMergeContactsQuery</span>) =&gt; res.mergeContacts,
  },
  GetMergeInvoices: {
    providesTags: [<span class="string">"MergeInvoices"</span>] <span class="keyword">as</span> <span class="type">AddTagTypes</span>,
    transformResponse: (res: <span class="type">GetMergeInvoicesQuery</span>) =&gt; res.mergeInvoices,
  },

  <span class="comment">// Mutations</span>
  InitiateMergeConnection: {
    invalidatesTags: [<span class="string">"MergeConnection"</span>] <span class="keyword">as</span> <span class="type">AddTagTypes</span>,
    transformResponse: (res: <span class="type">InitiateMergeConnectionMutation</span>) =&gt; res,
  },
  CreateMergeInvoice: {
    invalidatesTags: [<span class="string">"MergeInvoices"</span>, <span class="string">"Orders"</span>] <span class="keyword">as</span> <span class="type">AddTagTypes</span>,
    transformResponse: (res: <span class="type">CreateMergeInvoiceMutation</span>) =&gt; res,
  },
  SyncOrderToMerge: {
    invalidatesTags: [<span class="string">"MergeInvoices"</span>, <span class="string">"Orders"</span>] <span class="keyword">as</span> <span class="type">AddTagTypes</span>,
    transformResponse: (res: <span class="type">SyncOrderToMergeMutation</span>) =&gt; res,
  },
  DisconnectMerge: {
    invalidatesTags: [<span class="string">"MergeConnection"</span>] <span class="keyword">as</span> <span class="type">AddTagTypes</span>,
    transformResponse: (res: <span class="type">DisconnectMergeMutation</span>) =&gt; res,
  },
};

<span class="comment">// Add tag types to base API</span>
<span class="keyword">export const</span> mergeTags = [
  <span class="string">"MergeConnection"</span>,
  <span class="string">"MergeContacts"</span>,
  <span class="string">"MergeInvoices"</span>,
  <span class="string">"MergeItems"</span>,
] <span class="keyword">as const</span>;</code></pre>
                    </div>
                </details>

                <details>
                    <summary>4.4 GraphQL Operations - merge.graphql</summary>
                    <div>
                        <p>Based on <code>src/gql/queries/customer.graphql</code> pattern:</p>
<pre><code><span class="comment"># src/gql/queries/merge.graphql</span>

<span class="comment"># ═══════════════════════════════════════════════════════════════════</span>
<span class="comment"># QUERIES</span>
<span class="comment"># ═══════════════════════════════════════════════════════════════════</span>

<span class="keyword">query</span> <span class="function">GetMergeConnection</span>(<span class="type">$tenantId</span>: String!) {
  mergeConnection(tenantId: <span class="type">$tenantId</span>) {
    ...<span class="type">MergeConnectionFields</span>
  }
}

<span class="keyword">query</span> <span class="function">GetMergeContacts</span>(
  <span class="type">$tenantId</span>: String!
  <span class="type">$first</span>: Int
  <span class="type">$after</span>: String
) {
  mergeContacts(tenantId: <span class="type">$tenantId</span>, first: <span class="type">$first</span>, after: <span class="type">$after</span>) {
    nodes {
      ...<span class="type">MergeContactFields</span>
    }
    pageInfo {
      ...<span class="type">PageInfo</span>
    }
    totalCount
  }
}

<span class="keyword">query</span> <span class="function">GetMergeInvoices</span>(
  <span class="type">$tenantId</span>: String!
  <span class="type">$first</span>: Int
  <span class="type">$after</span>: String
) {
  mergeInvoices(tenantId: <span class="type">$tenantId</span>, first: <span class="type">$first</span>, after: <span class="type">$after</span>) {
    nodes {
      ...<span class="type">MergeInvoiceFields</span>
    }
    pageInfo {
      ...<span class="type">PageInfo</span>
    }
    totalCount
  }
}

<span class="comment"># ═══════════════════════════════════════════════════════════════════</span>
<span class="comment"># MUTATIONS</span>
<span class="comment"># ═══════════════════════════════════════════════════════════════════</span>

<span class="keyword">mutation</span> <span class="function">InitiateMergeConnection</span>(<span class="type">$input</span>: InitiateMergeConnectionInput!) {
  initiateMergeConnection(input: <span class="type">$input</span>) {
    connection {
      ...<span class="type">MergeConnectionFields</span>
    }
    errors {
      message
    }
  }
}

<span class="keyword">mutation</span> <span class="function">DisconnectMerge</span>(<span class="type">$input</span>: DisconnectMergeInput!) {
  disconnectMerge(input: <span class="type">$input</span>) {
    success
    errors {
      message
    }
  }
}

<span class="keyword">mutation</span> <span class="function">SyncOrderToMerge</span>(<span class="type">$input</span>: SyncOrderToMergeInput!) {
  syncOrderToMerge(input: <span class="type">$input</span>) {
    order {
      orderId
      mergeInvoiceId
      accountingSyncStatus
      accountingSyncedAt
    }
    invoice {
      ...<span class="type">MergeInvoiceFields</span>
    }
    errors {
      message
    }
  }
}

<span class="comment"># ═══════════════════════════════════════════════════════════════════</span>
<span class="comment"># FRAGMENTS</span>
<span class="comment"># ═══════════════════════════════════════════════════════════════════</span>

<span class="keyword">fragment</span> <span class="type">MergeConnectionFields</span> <span class="keyword">on</span> <span class="type">MergeConnection</span> {
  id
  tenantId
  integrationName
  connectionStatus
  connectedAt
  lastSyncAt
  revenueAccountId
  cogsAccountId
  arAccountId
}

<span class="keyword">fragment</span> <span class="type">MergeContactFields</span> <span class="keyword">on</span> <span class="type">MergeContact</span> {
  id
  remoteId
  companyName
  status
  firstName
  lastName
  emailAddresses {
    emailAddress
    emailAddressType
  }
  phoneNumbers {
    phoneNumber
    phoneNumberType
  }
  addresses {
    type
    street1
    city
    state
    postalCode
    country
  }
}

<span class="keyword">fragment</span> <span class="type">MergeInvoiceFields</span> <span class="keyword">on</span> <span class="type">MergeInvoice</span> {
  id
  remoteId
  number
  type
  status
  issueDate
  dueDate
  contact
  purchaseOrder
  totalAmount
  lineItems {
    item
    description
    quantity
    unitPrice
    totalLineAmount
  }
}</code></pre>
                    </div>
                </details>

                <details>
                    <summary>4.5 React Components</summary>
                    <div>
                        <h4>MergeLinkButton.tsx</h4>
                        <p>Based on <code>src/components/Buttons.tsx</code> pattern:</p>
<pre><code><span class="comment">// src/components/merge/MergeLinkButton.tsx</span>
<span class="keyword">import</span> { Button, <span class="type">ButtonProps</span>, CircularProgress, Icon } <span class="keyword">from</span> <span class="string">"@mui/material"</span>;
<span class="keyword">import</span> { useCallback, useEffect, useRef, useState } <span class="keyword">from</span> <span class="string">"react"</span>;

<span class="keyword">import</span> <span class="type">MergeService</span> <span class="keyword">from</span> <span class="string">"~/services/merge"</span>;
<span class="keyword">import</span> { useAppDispatch } <span class="keyword">from</span> <span class="string">"~/hooks/reduxHooks"</span>;
<span class="keyword">import</span> { setConnection, setConnectionStatus } <span class="keyword">from</span> <span class="string">"~/store/mergeSlice"</span>;

<span class="keyword">interface</span> <span class="type">MergeLinkButtonProps</span> <span class="keyword">extends</span> <span class="type">Omit</span>&lt;<span class="type">ButtonProps</span>, <span class="string">"onClick"</span>&gt; {
  onError?: (error: <span class="type">Error</span>) =&gt; <span class="keyword">void</span>;
  onSuccess?: (accountToken: <span class="type">string</span>) =&gt; <span class="keyword">void</span>;
  organizationId: <span class="type">string</span>;
  organizationName: <span class="type">string</span>;
}

<span class="keyword">export const</span> <span class="function">MergeLinkButton</span>: <span class="type">React.FC</span>&lt;<span class="type">MergeLinkButtonProps</span>&gt; = ({
  children,
  onError,
  onSuccess,
  organizationId,
  organizationName,
  ...props
}) =&gt; {
  <span class="keyword">const</span> dispatch = <span class="function">useAppDispatch</span>();
  <span class="keyword">const</span> mergeService = <span class="function">useRef</span>(<span class="type">MergeService</span>.<span class="function">getInstance</span>());
  <span class="keyword">const</span> [isLoading, setIsLoading] = <span class="function">useState</span>(<span class="keyword">false</span>);
  <span class="keyword">const</span> [mergeLink, setMergeLink] = <span class="function">useState</span>&lt;<span class="keyword">typeof</span> window.MergeLink | <span class="keyword">null</span>&gt;(<span class="keyword">null</span>);

  <span class="comment">// Load Merge Link SDK</span>
  <span class="function">useEffect</span>(() =&gt; {
    <span class="keyword">const</span> script = document.<span class="function">createElement</span>(<span class="string">"script"</span>);
    script.src = <span class="string">"https://cdn.merge.dev/merge-link.js"</span>;
    script.async = <span class="keyword">true</span>;
    script.onload = () =&gt; {
      <span class="keyword">if</span> (<span class="keyword">typeof</span> window !== <span class="string">"undefined"</span> && window.MergeLink) {
        <span class="function">setMergeLink</span>(window.MergeLink);
      }
    };
    document.body.<span class="function">appendChild</span>(script);
    <span class="keyword">return</span> () =&gt; { document.body.<span class="function">removeChild</span>(script); };
  }, []);

  <span class="keyword">const</span> handleClick = <span class="function">useCallback</span>(<span class="keyword">async</span> () =&gt; {
    <span class="keyword">if</span> (!mergeLink) <span class="keyword">return</span>;

    <span class="function">setIsLoading</span>(<span class="keyword">true</span>);
    <span class="function">dispatch</span>(<span class="function">setConnectionStatus</span>(<span class="string">"connecting"</span>));

    <span class="keyword">try</span> {
      <span class="comment">// Get link token from backend</span>
      <span class="keyword">const</span> linkTokenResponse = <span class="keyword">await</span> mergeService.current.<span class="function">getLinkToken</span>({
        categories: [<span class="string">"accounting"</span>],
        endUserOrganizationName: organizationName,
        endUserOriginId: organizationId,
      });

      <span class="keyword">if</span> (!linkTokenResponse) {
        <span class="keyword">throw new</span> <span class="type">Error</span>(<span class="string">"Failed to get link token"</span>);
      }

      <span class="comment">// Initialize and open Merge Link</span>
      mergeLink.<span class="function">initialize</span>({
        linkToken: linkTokenResponse.linkToken,
        onSuccess: <span class="keyword">async</span> (publicToken: <span class="type">string</span>) =&gt; {
          <span class="keyword">try</span> {
            <span class="keyword">const</span> accountTokenResponse = 
              <span class="keyword">await</span> mergeService.current.<span class="function">exchangePublicToken</span>(publicToken);

            <span class="keyword">if</span> (!accountTokenResponse) {
              <span class="keyword">throw new</span> <span class="type">Error</span>(<span class="string">"Failed to exchange public token"</span>);
            }

            mergeService.current.<span class="function">initialize</span>(accountTokenResponse.accountToken);

            <span class="function">dispatch</span>(<span class="function">setConnection</span>({
              accountToken: accountTokenResponse.accountToken,
              connectedAt: <span class="keyword">new</span> <span class="type">Date</span>().<span class="function">toISOString</span>() <span class="keyword">as never</span>,
              connectionStatus: <span class="string">"connected"</span>,
              integrationName: accountTokenResponse.integration.name,
            }));

            onSuccess?.(accountTokenResponse.accountToken);
          } <span class="keyword">catch</span> (error) {
            <span class="function">dispatch</span>(<span class="function">setConnectionStatus</span>(<span class="string">"error"</span>));
            onError?.(error <span class="keyword">as</span> <span class="type">Error</span>);
          } <span class="keyword">finally</span> {
            <span class="function">setIsLoading</span>(<span class="keyword">false</span>);
          }
        },
        onExit: () =&gt; {
          <span class="function">setIsLoading</span>(<span class="keyword">false</span>);
          <span class="function">dispatch</span>(<span class="function">setConnectionStatus</span>(<span class="string">"disconnected"</span>));
        },
      });

      mergeLink.<span class="function">open</span>();
    } <span class="keyword">catch</span> (error) {
      <span class="function">setIsLoading</span>(<span class="keyword">false</span>);
      <span class="function">dispatch</span>(<span class="function">setConnectionStatus</span>(<span class="string">"error"</span>));
      onError?.(error <span class="keyword">as</span> <span class="type">Error</span>);
    }
  }, [mergeLink, organizationId, organizationName, dispatch, onSuccess, onError]);

  <span class="keyword">return</span> (
    &lt;<span class="type">Button</span>
      color=<span class="string">"primary"</span>
      disabled={isLoading || !mergeLink}
      onClick={handleClick}
      startIcon={isLoading ? &lt;<span class="type">CircularProgress</span> size={<span class="number">20</span>} /&gt; : &lt;<span class="type">Icon</span>&gt;link&lt;/<span class="type">Icon</span>&gt;}
      variant=<span class="string">"contained"</span>
      {...props}
    &gt;
      {children || <span class="string">"Connect Accounting Software"</span>}
    &lt;/<span class="type">Button</span>&gt;
  );
};

<span class="keyword">export default</span> MergeLinkButton;</code></pre>

                        <h4>SyncStatusBadge.tsx</h4>
<pre><code><span class="comment">// src/components/merge/SyncStatusBadge.tsx</span>
<span class="keyword">import</span> { Chip, <span class="type">ChipProps</span>, Icon, Tooltip } <span class="keyword">from</span> <span class="string">"@mui/material"</span>;
<span class="keyword">import</span> { <span class="type">MergeSyncStatus</span> } <span class="keyword">from</span> <span class="string">"~/store/mergeSlice"</span>;

<span class="keyword">interface</span> <span class="type">SyncStatusBadgeProps</span> <span class="keyword">extends</span> <span class="type">Omit</span>&lt;<span class="type">ChipProps</span>, <span class="string">"color"</span> | <span class="string">"icon"</span> | <span class="string">"label"</span>&gt; {
  errorMessage?: <span class="type">string</span> | <span class="keyword">null</span>;
  status: <span class="type">MergeSyncStatus</span>;
  syncedAt?: <span class="type">string</span> | <span class="keyword">null</span>;
}

<span class="keyword">const</span> statusConfig: <span class="type">Record</span>&lt;
  <span class="type">MergeSyncStatus</span>,
  { color: <span class="type">ChipProps</span>[<span class="string">"color"</span>]; icon: <span class="type">string</span>; label: <span class="type">string</span> }
&gt; = {
  error: { color: <span class="string">"error"</span>, icon: <span class="string">"error"</span>, label: <span class="string">"Sync Failed"</span> },
  idle: { color: <span class="string">"default"</span>, icon: <span class="string">"schedule"</span>, label: <span class="string">"Not Synced"</span> },
  pending: { color: <span class="string">"warning"</span>, icon: <span class="string">"sync"</span>, label: <span class="string">"Syncing..."</span> },
  synced: { color: <span class="string">"success"</span>, icon: <span class="string">"check_circle"</span>, label: <span class="string">"Synced"</span> },
};

<span class="keyword">export const</span> <span class="function">SyncStatusBadge</span>: <span class="type">React.FC</span>&lt;<span class="type">SyncStatusBadgeProps</span>&gt; = ({
  errorMessage,
  status,
  syncedAt,
  ...props
}) =&gt; {
  <span class="keyword">const</span> config = statusConfig[status];

  <span class="keyword">const</span> <span class="function">tooltipContent</span> = () =&gt; {
    <span class="keyword">if</span> (status === <span class="string">"error"</span> && errorMessage) {
      <span class="keyword">return</span> <span class="string">`Error: ${errorMessage}`</span>;
    }
    <span class="keyword">if</span> (status === <span class="string">"synced"</span> && syncedAt) {
      <span class="keyword">return</span> <span class="string">`Synced: ${new Date(syncedAt).toLocaleString()}`</span>;
    }
    <span class="keyword">return</span> config.label;
  };

  <span class="keyword">return</span> (
    &lt;<span class="type">Tooltip</span> title={<span class="function">tooltipContent</span>()}&gt;
      &lt;<span class="type">Chip</span>
        color={config.color}
        icon={&lt;<span class="type">Icon</span>&gt;{config.icon}&lt;/<span class="type">Icon</span>&gt;}
        label={config.label}
        size=<span class="string">"small"</span>
        variant=<span class="string">"outlined"</span>
        {...props}
      /&gt;
    &lt;/<span class="type">Tooltip</span>&gt;
  );
};

<span class="keyword">export default</span> SyncStatusBadge;</code></pre>
                    </div>
                </details>

                <details>
                    <summary>4.6 Database Schema Migrations</summary>
                    <div>
<pre><code><span class="comment">-- Migration: 001_add_merge_integration_tables.sql</span>

<span class="comment">-- Table: merge_connections</span>
<span class="comment">-- Stores Merge.dev connection info per tenant</span>
<span class="keyword">CREATE TABLE</span> merge_connections (
    id <span class="type">UUID</span> <span class="keyword">PRIMARY KEY DEFAULT</span> <span class="function">gen_random_uuid</span>(),
    tenant_id <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL UNIQUE</span>,
    account_token <span class="type">VARCHAR</span>(<span class="number">500</span>) <span class="keyword">NOT NULL</span>, <span class="comment">-- Encrypt at rest!</span>
    integration_name <span class="type">VARCHAR</span>(<span class="number">100</span>),
    connection_status <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="string">'active'</span>,
    connected_at <span class="type">TIMESTAMP WITH TIME ZONE</span> <span class="keyword">NOT NULL DEFAULT NOW</span>(),
    last_sync_at <span class="type">TIMESTAMP WITH TIME ZONE</span>,

    <span class="comment">-- Account mapping preferences</span>
    revenue_account_id <span class="type">VARCHAR</span>(<span class="number">255</span>),
    cogs_account_id <span class="type">VARCHAR</span>(<span class="number">255</span>),
    ar_account_id <span class="type">VARCHAR</span>(<span class="number">255</span>),

    created_at <span class="type">TIMESTAMP WITH TIME ZONE</span> <span class="keyword">DEFAULT NOW</span>(),
    updated_at <span class="type">TIMESTAMP WITH TIME ZONE</span> <span class="keyword">DEFAULT NOW</span>()
);

<span class="keyword">CREATE INDEX</span> idx_merge_connections_tenant 
    <span class="keyword">ON</span> merge_connections(tenant_id);

<span class="comment">-- Table: accounting_sync_log</span>
<span class="comment">-- Audit log for all sync operations</span>
<span class="keyword">CREATE TABLE</span> accounting_sync_log (
    id <span class="type">UUID</span> <span class="keyword">PRIMARY KEY DEFAULT</span> <span class="function">gen_random_uuid</span>(),
    tenant_id <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT NULL</span>,
    order_id <span class="type">VARCHAR</span>(<span class="number">255</span>),
    customer_id <span class="type">VARCHAR</span>(<span class="number">255</span>),
    item_id <span class="type">VARCHAR</span>(<span class="number">255</span>),
    sync_type <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,
    merge_object_type <span class="type">VARCHAR</span>(<span class="number">50</span>),
    merge_object_id <span class="type">VARCHAR</span>(<span class="number">255</span>),
    status <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,
    error_message <span class="type">TEXT</span>,
    request_payload <span class="type">JSONB</span>,
    response_payload <span class="type">JSONB</span>,
    created_at <span class="type">TIMESTAMP WITH TIME ZONE</span> <span class="keyword">DEFAULT NOW</span>()
);

<span class="keyword">CREATE INDEX</span> idx_sync_log_tenant <span class="keyword">ON</span> accounting_sync_log(tenant_id);
<span class="keyword">CREATE INDEX</span> idx_sync_log_order <span class="keyword">ON</span> accounting_sync_log(order_id);
<span class="keyword">CREATE INDEX</span> idx_sync_log_status <span class="keyword">ON</span> accounting_sync_log(status);

<span class="comment">-- Alter customers table</span>
<span class="keyword">ALTER TABLE</span> customers 
    <span class="keyword">ADD COLUMN</span> merge_contact_id <span class="type">VARCHAR</span>(<span class="number">255</span>),
    <span class="keyword">ADD COLUMN</span> accounting_sync_status <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="string">'idle'</span>,
    <span class="keyword">ADD COLUMN</span> accounting_synced_at <span class="type">TIMESTAMP WITH TIME ZONE</span>;

<span class="comment">-- Alter items table</span>
<span class="keyword">ALTER TABLE</span> items
    <span class="keyword">ADD COLUMN</span> merge_item_id <span class="type">VARCHAR</span>(<span class="number">255</span>),
    <span class="keyword">ADD COLUMN</span> accounting_synced_at <span class="type">TIMESTAMP WITH TIME ZONE</span>;

<span class="comment">-- Alter orders table</span>
<span class="keyword">ALTER TABLE</span> orders
    <span class="keyword">ADD COLUMN</span> merge_invoice_id <span class="type">VARCHAR</span>(<span class="number">255</span>),
    <span class="keyword">ADD COLUMN</span> accounting_invoice_number <span class="type">VARCHAR</span>(<span class="number">100</span>),
    <span class="keyword">ADD COLUMN</span> accounting_sync_status <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="string">'idle'</span>,
    <span class="keyword">ADD COLUMN</span> accounting_synced_at <span class="type">TIMESTAMP WITH TIME ZONE</span>,
    <span class="keyword">ADD COLUMN</span> accounting_sync_error <span class="type">TEXT</span>;

<span class="keyword">CREATE INDEX</span> idx_orders_merge_invoice <span class="keyword">ON</span> orders(merge_invoice_id);
<span class="keyword">CREATE INDEX</span> idx_orders_sync_status <span class="keyword">ON</span> orders(accounting_sync_status);</code></pre>
                    </div>
                </details>
            </section>

            <!-- IMPLEMENTATION PHASES -->
            <section id="implementation" class="page-break">
                <h2>5. Implementation Phases</h2>

                <h3>Phase 1: MVP (2-3 Weeks)</h3>
                <p><strong>Goal:</strong> Sync shipped orders to accounting system as invoices</p>

                <table>
                    <tr>
                        <th>Task</th>
                        <th>Effort</th>
                        <th>Dependencies</th>
                    </tr>
                    <tr><td>MergeService singleton implementation</td><td>3 days</td><td>None</td></tr>
                    <tr><td>Database schema migrations</td><td>1 day</td><td>None</td></tr>
                    <tr><td>GraphQL schema & resolvers (backend)</td><td>3 days</td><td>Database</td></tr>
                    <tr><td>Redux slice & RTK Query endpoints</td><td>2 days</td><td>GraphQL</td></tr>
                    <tr><td>MergeLinkButton component</td><td>1 day</td><td>MergeService</td></tr>
                    <tr><td>Connection status UI</td><td>1 day</td><td>Redux</td></tr>
                    <tr><td>Order status event handler (auto-sync)</td><td>2 days</td><td>All above</td></tr>
                    <tr><td>Basic error handling & logging</td><td>1 day</td><td>All above</td></tr>
                    <tr><td>Testing & QA with QuickBooks sandbox</td><td>2 days</td><td>All above</td></tr>
                </table>

                <div class="card">
                    <h4>MVP Deliverables</h4>
                    <ul>
                        <li><span class="badge badge-success">✓</span> Merge Link authentication flow</li>
                        <li><span class="badge badge-success">✓</span> Customer sync (lazy - on first invoice)</li>
                        <li><span class="badge badge-success">✓</span> Automatic invoice creation when order shipped</li>
                        <li><span class="badge badge-success">✓</span> Sync status indicators on orders</li>
                        <li><span class="badge badge-success">✓</span> Basic error handling with toast notifications</li>
                    </ul>
                    <p><strong>Total Estimate:</strong> 2-3 weeks (1 backend + 1 frontend developer)</p>
                </div>

                <h3>Phase 2: Enhanced Features (2-3 Weeks)</h3>
                <table>
                    <tr>
                        <th>Task</th>
                        <th>Effort</th>
                    </tr>
                    <tr><td>Manual sync approval workflow (review before sync)</td><td>3 days</td></tr>
                    <tr><td>Bulk sync UI for missed/failed orders</td><td>2 days</td></tr>
                    <tr><td>Sync history/audit log UI</td><td>2 days</td></tr>
                    <tr><td>Error retry mechanism with backoff</td><td>2 days</td></tr>
                    <tr><td>Per-customer account mapping</td><td>2 days</td></tr>
                    <tr><td>Credit note support for cancelled orders</td><td>3 days</td></tr>
                </table>

                <h3>Phase 3: Advanced (4-6 Weeks, Future)</h3>
                <table>
                    <tr>
                        <th>Task</th>
                        <th>Effort</th>
                    </tr>
                    <tr><td>Payment tracking in FULFILL</td><td>1 week</td></tr>
                    <tr><td>Payment sync to accounting</td><td>3 days</td></tr>
                    <tr><td>Per-item COGS account mapping</td><td>3 days</td></tr>
                    <tr><td>Bidirectional sync (pull payment status)</td><td>1 week</td></tr>
                    <tr><td>Financial reporting dashboard</td><td>1 week</td></tr>
                    <tr><td>Multi-currency support</td><td>3 days</td></tr>
                </table>
            </section>

            <!-- TESTING STRATEGY -->
            <section id="testing" class="page-break">
                <h2>6. Testing Strategy</h2>

                <h3>6.1 QuickBooks Sandbox Setup</h3>
                <div class="card">
                    <ol>
                        <li><strong>Create Intuit Developer Account</strong>
                            <ul>
                                <li>Go to <a href="https://developer.intuit.com">developer.intuit.com</a></li>
                                <li>Sign up for free developer account</li>
                                <li>You automatically get sandbox access</li>
                            </ul>
                        </li>
                        <li><strong>Create Sandbox Company</strong>
                            <ul>
                                <li>Dashboard → Sandbox → Create Sandbox</li>
                                <li>Select US company type</li>
                                <li>Note the sandbox company name</li>
                            </ul>
                        </li>
                        <li><strong>Configure Merge.dev</strong>
                            <ul>
                                <li>In Merge Dashboard: Integrations → Accounting</li>
                                <li>Expand QuickBooks Online</li>
                                <li>Add redirect URI: <code>https://app.merge.dev/oauth/callback</code></li>
                            </ul>
                        </li>
                        <li><strong>Test Connection</strong>
                            <ul>
                                <li>Use Merge Link to connect to sandbox</li>
                                <li>Verify data retrieval works</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <h3>6.2 Test Scenarios</h3>
                <table>
                    <tr>
                        <th>Scenario</th>
                        <th>Steps</th>
                        <th>Expected Result</th>
                    </tr>
                    <tr>
                        <td>Connect QuickBooks</td>
                        <td>Click "Connect Accounting" → Select QuickBooks → Authenticate</td>
                        <td>Connection status = "connected", integration name shown</td>
                    </tr>
                    <tr>
                        <td>Create invoice from order</td>
                        <td>Ship an order with line items</td>
                        <td>Invoice created in QuickBooks, merge_invoice_id populated</td>
                    </tr>
                    <tr>
                        <td>Customer lazy sync</td>
                        <td>Ship order for new customer (not yet synced)</td>
                        <td>Contact created first, then invoice created</td>
                    </tr>
                    <tr>
                        <td>Sync failure handling</td>
                        <td>Ship order with invalid data (e.g., missing customer)</td>
                        <td>Error logged, status = "error", toast notification</td>
                    </tr>
                    <tr>
                        <td>Retry failed sync</td>
                        <td>Fix data, click "Retry Sync"</td>
                        <td>Invoice created, status = "synced"</td>
                    </tr>
                    <tr>
                        <td>Disconnect accounting</td>
                        <td>Click "Disconnect"</td>
                        <td>Connection cleared, existing orders retain sync status</td>
                    </tr>
                    <tr>
                        <td>Cancel synced order</td>
                        <td>Cancel an order that was already synced</td>
                        <td>Invoice voided in QuickBooks (Phase 2)</td>
                    </tr>
                </table>

                <h3>6.3 Edge Cases</h3>
                <ul>
                    <li><strong>Network timeout during sync</strong> → Retry with exponential backoff, max 3 attempts</li>
                    <li><strong>QuickBooks API rate limit</strong> → Queue and batch, respect 429 responses</li>
                    <li><strong>Duplicate invoice prevention</strong> → Check merge_invoice_id before creating</li>
                    <li><strong>Price = $0</strong> → Allow (free samples), validate total &gt;= 0</li>
                    <li><strong>100+ line items</strong> → Batch if needed, test performance</li>
                    <li><strong>Special characters in names</strong> → URL encode, test with unicode</li>
                </ul>
            </section>

            <!-- COST ANALYSIS -->
            <section id="costs" class="page-break">
                <h2>7. Cost Analysis</h2>

                <h3>7.1 Merge.dev Pricing</h3>
                <table class="cost-table">
                    <tr>
                        <th>Connected Customers</th>
                        <th>Monthly Cost</th>
                        <th>Annual Cost</th>
                        <th>Per Customer</th>
                    </tr>
                    <tr><td>1-3 (Free Tier)</td><td>$0</td><td>$0</td><td>$0</td></tr>
                    <tr><td>10</td><td>$650</td><td>$7,800</td><td>$65</td></tr>
                    <tr><td>25</td><td>$1,625</td><td>$19,500</td><td>$65</td></tr>
                    <tr><td>50</td><td>$3,250</td><td>$39,000</td><td>$65</td></tr>
                    <tr><td>100</td><td>$6,500</td><td>$78,000</td><td>$65</td></tr>
                </table>
                <p style="font-size: 0.85rem; color: var(--color-text-secondary);">
                    Launch Plan: $650/month base (includes 10 connections) + $65 per additional connection
                </p>

                <h3>7.2 Build vs. Buy Comparison</h3>
                <table>
                    <tr>
                        <th>Factor</th>
                        <th>Build In-House</th>
                        <th>Use Merge.dev</th>
                    </tr>
                    <tr>
                        <td>Initial Development</td>
                        <td>$150,000 - $300,000</td>
                        <td class="cost-highlight">~$15,000 (2-3 weeks dev)</td>
                    </tr>
                    <tr>
                        <td>Time to Market</td>
                        <td>6-12 months</td>
                        <td class="cost-highlight">2-3 weeks</td>
                    </tr>
                    <tr>
                        <td>Platforms Supported</td>
                        <td>1-2 initially</td>
                        <td class="cost-highlight">8+ immediately</td>
                    </tr>
                    <tr>
                        <td>Ongoing Maintenance</td>
                        <td>80-160 hrs/month (~$12k-24k/mo)</td>
                        <td class="cost-highlight">$0 (Merge handles)</td>
                    </tr>
                    <tr>
                        <td>API Change Management</td>
                        <td>Your responsibility</td>
                        <td class="cost-highlight">Merge handles</td>
                    </tr>
                    <tr>
                        <td>New Platform Support</td>
                        <td>2-3 months per platform</td>
                        <td class="cost-highlight">Already included</td>
                    </tr>
                </table>

                <h3>7.3 3-Year Total Cost of Ownership</h3>
                <p>Assuming growth to 50 connected customers by Year 3:</p>
                <table class="cost-table">
                    <tr>
                        <th>Approach</th>
                        <th>Year 1</th>
                        <th>Year 2</th>
                        <th>Year 3</th>
                        <th>3-Year Total</th>
                    </tr>
                    <tr>
                        <td>Build In-House</td>
                        <td>$200,000</td>
                        <td>$75,000</td>
                        <td>$75,000</td>
                        <td>$350,000</td>
                    </tr>
                    <tr class="cost-highlight">
                        <td>Merge.dev</td>
                        <td>$22,800*</td>
                        <td>$27,300</td>
                        <td>$39,000</td>
                        <td>$89,100</td>
                    </tr>
                </table>
                <p style="font-size: 0.85rem; color: var(--color-text-secondary);">
                    *Year 1: $15k dev + $7.8k Merge (10 customers). Assumes 20 customers Y2, 50 customers Y3.
                </p>

                <div class="card">
                    <h4>ROI Summary</h4>
                    <p><strong>3-Year Savings with Merge.dev: ~$260,000</strong></p>
                    <ul>
                        <li>74% cost reduction vs. building in-house</li>
                        <li>10x faster time-to-market</li>
                        <li>Zero ongoing maintenance burden on dev team</li>
                        <li>Dev team can focus on core FULFILL features</li>
                    </ul>
                </div>
            </section>

            <!-- FOOTER -->
            <footer style="margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--color-border); text-align: center; color: var(--color-text-secondary);">
                <p>
                    <strong>Merge.dev Integration Scoping Report</strong><br>
                    Generated: December 9, 2025<br>
                    Silver Fern Development Team
                </p>
                <p style="font-size: 0.8rem; margin-top: 1rem;">
                    This report follows worksuite-pwa coding patterns and conventions.
                    All code examples are production-ready templates.
                </p>
            </footer>
        </main>
    </div>
</body>
</html>
